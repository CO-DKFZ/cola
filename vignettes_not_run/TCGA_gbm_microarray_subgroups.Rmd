---
title: "cola"

output:
  html_document:
    css: "style.css"
---

```{r}
library(cola)
```

Data is from https://tcga-data.nci.nih.gov/docs/publications/gbm_exp/.

```{r}
data = read.table("~/analysis/unifiedScaled.txt", 
	header = TRUE, row.names = 1, check.names = FALSE)
data = as.matrix(data)

subtype = read.table("~/analysis/TCGA_unified_CORE_ClaNC840.txt", 
	sep = "\t", header = TRUE, check.names = FALSE, stringsAsFactors = FALSE)
subtype = structure(unlist(subtype[1, -(1:2)]), names = colnames(subtype)[-(1:2)])

data = data[, names(subtype)]
dim(data)
table(subtype)
```

Get all supported top methods and partition methods:

```{r}
all_top_value_methods()
all_partition_methods()
```

```{r}
register_top_value_fun(AAC = function(mat) AAC(t(mat), mc.cores = 4))
```

Run clustering for all combination of methods in batch:

```{r, eval = FALSE}
res = run_all_consensus_partition_methods(data, top_n = c(1000, 2000, 4000), k = 2:6, mc.cores = 4,
	known_anno = data.frame(subtype = subtype), 
	known_col = list(subtype = structure(seq_len(4), names = unique(subtype))))
```

```{r}
res_list = readRDS("~/analysis/TCGA_subgroup_p0.8.rds")
res_list
```

```{r}
get_best_k(res_list)
```

Collect all plots for a k:

```{r, fig.width = 14, fig.height = 14*length(all_top_value_methods())/length(all_partition_methods()), results = "hide"}
collect_plots(res_list, k = 4, fun = plot_ecdf)
collect_plots(res_list, k = 4, fun = consensus_heatmap)
collect_plots(res_list, k = 4, fun = membership_heatmap)
# collect_plots(res_list, k = 3, fun = get_signatures)
```

```{r}
get_stat(res_list, k = 4)
```

```{r}
collect_classes(res_list, k = 4)
```

Overlap of top rows in different top methods:

```{r, fig.width = 14, fig.height = 14/3}
par(mfrow = c(1, 3))
top_rows_overlap(res_list, top_n = 1000)
top_rows_overlap(res_list, top_n = 2000)
top_rows_overlap(res_list, top_n = 4000)
```

Also visualize the correspondance of rankings between different scoreing methods:

```{r, fig.width = 14, fig.height = 8}
top_rows_overlap(res_list, top_n = 1000, type = "correspondance")
```

Heatmaps for the top rows:

```{r, fig.width = 14, fig.height = 14/4}
top_rows_heatmap(res_list, top_n = 1000)
```

Get clustering in a specified combination of top method and partition method:

```{r}
res = get_single_run(res_list, top_method = "MAD", partition_method = "kmeans")
res
```

Collect all plots

```{r, fig.width = 14, fig.height = 14*4/5, results = "hide"}
collect_plots(res)
```

plots:

```{r, results = "hide", fig.width = 10}
select_partition_number(res)
```

```{r}
get_best_k(res)
consensus_heatmap(res, k = 4)
membership_heatmap(res, k = 4)
# get_signatures(res, k = 4)
```

Get classifications

```{r}
get_class(res, k = 4)
```

MDS or T-sne plots:

```{r}
dimension_reduction(res, k = 4)
dimension_reduction(res, k = 4, method = "tsne")
```

Consistency of classes.

```{r}
collect_classes(res_list, k = 4)
collect_classes(res)
```

```{r, eval = FALSE}
res = hierarchical_partition(data, top_n = c(1000, 2000, 4000), 
	known_anno = data.frame(subtype = subtype), 
	known_col = list(subtype = structure(seq_len(4), names = unique(subtype))))
```

```{r}
res = readRDS("~/analysis/TCGA_subgroup_hierarchical_partition.rds")
res
```

```{r}
collect_classes(res)
```

```{r}
get_class(res)
```

